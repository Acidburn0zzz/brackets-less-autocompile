/*jslint vars: true, plusplus: true, devel: true, nomen: true, indent: 4,
maxerr: 50, node: true */
/*global */

(function () {
    "use strict";

    var less = require("less");
    var path = require("path");
    var fs = require("fs");
    var mkpath = require("mkpath");

    function readLessFile(lessFile, callback) {

        // read less input
        fs.readFile(lessFile, function (err, data) {
            if (err) {
                callback(err);
                return;
            }

            var content = data.toString();
            var result = { "content": content };

            // match // in the first line
            var match = /^\s*\/\/\s*(\S+):\s*(\S+)/.exec(content);
            if (match) {
                if (match[1] === "out") {
                    result.out = match[2];
                } else if (match[1] === "main") {
                    result.main = match[2];
                }
            }
            callback(null, result);
        });

    }

    // compile the given less file
    function compile(lessFile, callback) {

        // read the less file, returns object with the following keys:
        // - content: content of the file
        // - out: override output filename (optional)
        // - main: override compile file (optional)
        readLessFile(lessFile, function (err, result) {
            if (err) {
                callback(err);
                return;
            }

            // compile a different file instead
            if (result.main) {
                var mainFile = path.join(path.dirname(lessFile), result.main);
                compile(mainFile, callback);
                return;
            }

            // determine output filename
            var lessPath = path.dirname(lessFile);
            var cssFile;
            if (result.out) {
                cssFile = path.join(lessPath, result.out);
                if (path.extname(cssFile) === "") {
                    cssFile += ".css";
                }
            } else {
                cssFile = lessFile.substr(0, lessFile.length - 5) + ".css";
            }

            // create less parser
            var parser = new less.Parser({
                paths: [lessPath],
                filename: path.basename(lessFile)
            });

            // parse the file
            parser.parse(result.content, function (err, tree) {
                if (err) {
                    callback(err);
                    return;
                }

                var fileHeader = "/* Generated by less " + less.version.join(".") + " */\n";
                var output = fileHeader + tree.toCSS({strictMath: true});

                // write css output
                mkfile(cssFile, output, function (err) {
                    if (err) {
                        callback(err);
                    } else {
                        callback(null, { filepath: cssFile, output: output });
                    }
                });
            });
        });
    }

    // makes a file in a path where directories may or may not have existed before
    var mkfile = function (filepath, content, callback) {
        mkpath(path.dirname(filepath), function (err) {
            if (err) {
                callback(err);
            } else {
                fs.writeFile(filepath, content, callback);
            }
        });
    };

    // set up service for brackets
    function init(DomainManager) {
        if (!DomainManager.hasDomain("LessCompiler")) {
            DomainManager.registerDomain("LessCompiler", {
                major: 1,
                minor: 0
            });
        }
        DomainManager.registerCommand(
            "LessCompiler", // domain name
            "compile", // command name
            compile, // command handler function
            true, // this command is asynchronous
            "Compiles a less file", ["lessPath"], // path parameters
            null);
    }

    exports.init = init;

}());
